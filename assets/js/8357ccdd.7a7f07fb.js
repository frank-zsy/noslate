"use strict";(self.webpackChunknoslate_website=self.webpackChunknoslate_website||[]).push([[5257],{3905:(e,n,t)=>{t.d(n,{Zo:()=>s,kt:()=>x});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function c(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function p(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?c(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):c(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},c=Object.keys(e);for(a=0;a<c.length;a++)t=c[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(a=0;a<c.length;a++)t=c[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),i=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):p(p({},n),e)),t},s=function(e){var n=i(e.components);return a.createElement(o.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,c=e.originalType,o=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),d=i(t),x=r,m=d["".concat(o,".").concat(x)]||d[x]||u[x]||c;return t?a.createElement(m,p(p({ref:n},s),{},{components:t})):a.createElement(m,p({ref:n},s))}));function x(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var c=t.length,p=new Array(c);p[0]=d;var l={};for(var o in n)hasOwnProperty.call(n,o)&&(l[o]=n[o]);l.originalType=e,l.mdxType="string"==typeof e?e:r,p[1]=l;for(var i=2;i<c;i++)p[i]=t[i];return a.createElement.apply(null,p)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},1496:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>p,default:()=>u,frontMatter:()=>c,metadata:()=>l,toc:()=>i});var a=t(7462),r=(t(7294),t(3905));const c={},p="heap \u547d\u4ee4",l={unversionedId:"debugger/andb/heap",id:"debugger/andb/heap",title:"heap \u547d\u4ee4",description:"heap space",source:"@site/docs/debugger/andb/heap.md",sourceDirName:"debugger/andb",slug:"/debugger/andb/heap",permalink:"/docs/debugger/andb/heap",draft:!1,editUrl:"https://github.com/noslate-project/noslate/tree/main/site/docs/debugger/andb/heap.md",tags:[],version:"current",frontMatter:{},sidebar:"debugger",previous:{title:"v8 \u547d\u4ee4",permalink:"/docs/debugger/andb/v8"},next:{title:"mm \u547d\u4ee4",permalink:"/docs/debugger/andb/mm"}},o={},i=[{value:"heap space",id:"heap-space",level:2},{value:"heap page",id:"heap-page",level:2},{value:"heap summary",id:"heap-summary",level:2},{value:"heap find",id:"heap-find",level:2},{value:"heap snapshot",id:"heap-snapshot",level:2}],s={toc:i};function u(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"heap-\u547d\u4ee4"},"heap \u547d\u4ee4"),(0,r.kt)("h2",{id:"heap-space"},"heap space"),(0,r.kt)("p",null,"\u663e\u793a V8 Heap \u7684 Space \u4fe1\u606f\u3002"),(0,r.kt)("p",null,"V8 \u7684\u5806\u91c7\u7528 Space + Page \u7ed3\u6784\uff0c\u82e5\u5e72\u4e2a Page \u6784\u6210\u4e00\u4e2a Space\uff0c\u82e5\u5e72\u4e2a Space \u6784\u6210 v8 \u7684\u5806\u3002"),(0,r.kt)("p",null,"\u6309\u7167\u65b0\u8001\u751f\u4ee3\u53ca\u7528\u9014\uff0c\u5206\u4e3a\u5982 new(\u65b0\u751f\u4ee3)\uff0cnew_lo(\u65b0\u751f\u4ee3\u5927\u5bf9\u8c61), old(\u8001\u751f\u4ee3)\uff0clo(\u8001\u751f\u4ee3\u5927\u5bf9\u8c61), ro(\u53ea\u8bfb\u5bf9\u8c61) \u7b49\u591a\u4e2a Space.",(0,r.kt)("br",{parentName:"p"}),"\n","\u901a\u5e38\u7528\u4e8e\u5b58\u653e\u5c0f\u5bf9\u8c61\u7684 Page \u91c7\u7528\u7684 256K \u7684\u5927\u5c0f\uff0c\u5b58\u653e\u5927\u5bf9\u8c61\u7684 Page \u53ea\u542b\u6709\u4e00\u4e2a\u5bf9\u8c61\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"heap space"),(0,r.kt)("li",{parentName:"ul"},"heap space ","[space_name]",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"space_name : old, new, lo, map, code etc.")))),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"heap space")," \u7528\u4e8e\u663e\u793a v8 \u5806\u5185\u7684 Space \u7a7a\u95f4\u4f7f\u7528\u60c5\u51b5\uff0c\u5176\u4e2d Commit \u662f\u63d0\u4ea4\u7684\u5927\u5c0f\uff0c Max \u662f\u6700\u5927\u4f7f\u7528\u7684\u5927\u5c0f\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"(gdb) heap space\nSPACE NAME          COMMIT        MAX\nRO_SPACE      :     151552     262144\nMAP_SPACE     :     528384     528384\nCODE_SPACE    :     360448     360448\nCODE_LO_SPACE :      49152      49152\nOLD_SPACE     :    2781184    4616192\nLO_SPACE      :     401408     401408\nNEW_LO_SPACE  :          0          0\nNEW_SPACE     :    1048576\n - from_space :          0\n - to_space   :    1048576\nTotal Committed    5320704\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"heap space new")," \u663e\u793a new space (\u65b0\u751f\u4ee3\u5c0f\u5bf9\u8c61) \u7684\u6240\u6709 pages\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"(gdb) heap space new\n    0x667900000 : size(262144), sweep(0), start(0x667900120)\n 0x176d3ce00000 : size(262144), sweep(0), start(0x176d3ce00120)\n 0x10d414980000 : size(262144), sweep(0), start(0x10d414980120)\n 0x159131e80000 : size(262144), sweep(0), start(0x159131e80120)\nTotal 4 pages.\n")),(0,r.kt)("h2",{id:"heap-page"},"heap page"),(0,r.kt)("p",null,"\u663e\u793a\u6307\u5b9a Page \u7684\u6240\u6709\u5bf9\u8c61 Brief\u3002"),(0,r.kt)("p",null,"Brief \u662f\u4e00\u79cd\u7528\u4e8e\u5355\u884c\u663e\u793a\u5bf9\u8c61\u7684\u7b80\u77ed\u5b57\u7b26\u4e32\uff0c\u4e00\u822c\u75312-3\u90e8\u5206\u7ec4\u6210\u3002",(0,r.kt)("br",{parentName:"p"}),"\n","\u5982 ",(0,r.kt)("inlineCode",{parentName:"p"},"<Type Info TagPointer>"),"\n\u4ece\u5de6\u5f80\u53f3\uff0c\u7b2c\u4e00\u90e8\u5206\u4e3a\u5bf9\u8c61\u7c7b\u578b\uff0c\u4e2d\u95f4\u90e8\u5206\u53ef\u80fd\u663e\u793a\u91cd\u8981\u63d0\u793a\uff0c\u6700\u53f3\u4fa7\u90e8\u5206\u663e\u793a\u5bf9\u8c61\u7684 Tagging Pointer\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"<JsFunction setTimeout 0x37c04dfc74f9>\n")),(0,r.kt)("p",null,"\u8bf4\u660e ",(0,r.kt)("inlineCode",{parentName:"p"},"0x37c04dfc74f9")," \u662f\u4e00\u4e2a ",(0,r.kt)("inlineCode",{parentName:"p"},"JsFunction")," \u5bf9\u8c61\uff0c\u540d\u79f0\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"setTimeout"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"heap page ","[page_address]",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"page_address: V8 Page \u8d77\u59cb\u5185\u5b58\u5730\u5740")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"(gdb) heap page 0x3c0214e40000\n0x3c0214e40120: <PropertyArray 0x3c0214e40120>\n0x3c0214e40140: <FunctionContext 0x3c0214e40140>\n0x3c0214e40168: <JsObject 0x3c0214e40168>\n0x3c0214e40180: <PropertyArray 0x3c0214e40180>\n0x3c0214e401a0: <FunctionContext 0x3c0214e401a0>\n0x3c0214e401c8: <JsObject 0x3c0214e401c8>\n0x3c0214e401e0: <PropertyArray 0x3c0214e401e0>\n0x3c0214e40200: <FunctionContext 0x3c0214e40200>\n0x3c0214e40228: <JsObject 0x3c0214e40228>\n0x3c0214e40240: <PropertyArray 0x3c0214e40240>\n0x3c0214e40260: <FunctionContext 0x3c0214e40260>\n0x3c0214e40288: <JsObject 0x3c0214e40288>\n0x3c0214e402a0: <PropertyArray 0x3c0214e402a0>\n0x3c0214e402c0: <FunctionContext 0x3c0214e402c0>\n0x3c0214e402e8: <JsObject 0x3c0214e402e8>\n0x3c0214e40300: <PropertyArray 0x3c0214e40300>\n0x3c0214e40320: <FunctionContext 0x3c0214e40320>\n0x3c0214e40348: <JsObject 0x3c0214e40348>\n0x3c0214e40360: <PropertyArray 0x3c0214e40360>\n0x3c0214e40380: <FunctionContext 0x3c0214e40380>\n0x3c0214e403a8: <JsObject 0x3c0214e403a8>\n0x3c0214e403c0: <PropertyArray 0x3c0214e403c0>\n0x3c0214e403e0: <FunctionContext 0x3c0214e403e0>\n0x3c0214e40408: <JsObject 0x3c0214e40408>\n0x3c0214e40420: <PropertyArray 0x3c0214e40420>\n0x3c0214e40438: <FunctionContext 0x3c0214e40438>\n...\n0x3c0214e503b0: <DescriptorArray 0x3c0214e503b0>\n0x3c0214e50440: <DescriptorArray 0x3c0214e50440>\n0x3c0214e504d0: <DescriptorArray 0x3c0214e504d0>\n0x3c0214e50530: <DescriptorArray 0x3c0214e50530>\n0x3c0214e505c0: <DescriptorArray 0x3c0214e505c0>\n0x3c0214e50650: <DescriptorArray 0x3c0214e50650>\n0x3c0214e506e0: <DescriptorArray 0x3c0214e506e0>\n0x3c0214e50770: <FreeSpace 0x3c0214e50770>\nTotal Cnt(1206)\nDumpChunk() takes 0.136 second(s).\n")),(0,r.kt)("h2",{id:"heap-summary"},"heap summary"),(0,r.kt)("p",null,"\u6458\u8981\u6307\u5b9a Space \u7684\u5bf9\u8c61\uff0c\u6309\u7167 map \u8fdb\u884c\u5f52\u7c7b\uff0c\u5e76\u6309\u7167\u6570\u91cf\u8fdb\u884c\u6392\u5e8f\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"heap summary ","[space_name]",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"space_name: new, old, lo, new_lo etc.")))),(0,r.kt)("p",null,"\u6807\u9898\u6309\u7167 ",(0,r.kt)("inlineCode",{parentName:"p"},"Map"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Count"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Bytes"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Type"),"\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"(gdb) heap sum old\n0x2048032c0829:        1           24 JS_OBJECT_TYPE\n0x2048032c0fc1:        1           24 JS_OBJECT_TYPE\n0x2048032c1099:        1           24 JS_OBJECT_TYPE\n0x2048032c1129:        1           24 JS_OBJECT_TYPE\n0x2048032c11b9:        1           24 JS_OBJECT_TYPE\n0x2048032c2719:        1           24 JS_OBJECT_TYPE\n0x2048032c27a9:        1           24 JS_OBJECT_TYPE\n0x2048032c2839:        1           24 JS_OBJECT_TYPE\n0x2048032c2f89:        1           24 JS_OBJECT_TYPE\n0x2048032c3019:        1           24 JS_OBJECT_TYPE\n...\n0x2048032c0c61:      487        50352 FUNCTION_CONTEXT_TYPE\n0x0b6f27201469:      492        15744 CALL_HANDLER_INFO_TYPE\n0x0b6f27200ec9:      497        18112 FEEDBACK_METADATA_TYPE\n0x0b6f27200fe9:      519       103592 BYTECODE_ARRAY_TYPE\n0x0b6f27204c19:      636        71232 FUNCTION_TEMPLATE_INFO_TYPE\n0x0b6f272058c1:      646        20672 LOAD_HANDLER_TYPE\n0x0b6f27200891:      701       123768 SCOPE_INFO_TYPE\n0x0b6f27201979:      835        26720 CONS_ONE_BYTE_STRING_TYPE\n0x0b6f27200729:      900       157952 FIXED_ARRAY_TYPE\n0x0b6f27201421:      930        43808 PROPERTY_ARRAY_TYPE\n0x0b6f272006e1:     1068        59336 BYTE_ARRAY_TYPE\n0x0b6f27200241:     1239       197352 DESCRIPTOR_ARRAY_TYPE\n0x0b6f272009f9:     1312        20992 FOREIGN_TYPE\n0x2048032c0751:     1484        94976 JS_FUNCTION_TYPE\n0x0b6f27201781:     1688        40512 UNCOMPILED_DATA_WITHOUT_PREPARSE_DATA_TYPE\n0x2048032c03f1:     1843       103208 JS_FUNCTION_TYPE\n0x0b6f272012b9:     2200        52800 FEEDBACK_CELL_TYPE\n0x0b6f27200849:     2464       103056 ONE_BYTE_STRING_TYPE\n0x0b6f272008d9:     3525       197400 SHARED_FUNCTION_INFO_TYPE\n0x0b6f27200409:     6858       234808 ONE_BYTE_INTERNALIZED_STRING_TYPE\nShowMapSummary() takes 1.582 second(s).\n")),(0,r.kt)("h2",{id:"heap-find"},"heap find"),(0,r.kt)("p",null,"\u5728 V8 \u5806\u4e2d\u67e5\u627e\u5f15\u7528\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"heap find ","[space_name][tagging]",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"space_name: new, old, lo, new_lo etc."),(0,r.kt)("li",{parentName:"ul"},"tagging: \u76ee\u6807\u5bf9\u8c61\u7684 Tagging Pointer")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"(gdb) heap find old 0x3c0214e4c391\n<FixedArray 0x3c0214e49e69>\nfind 1\n(gdb) heap find old 0x3c0214e49e69\n<JsArray 0xe953ab26d1>\nfind 1\n(gdb) heap find old 0xe953ab26d1\n<JsObject 0xe953ab2389>\nfind 1\n")),(0,r.kt)("h2",{id:"heap-snapshot"},"heap snapshot"),(0,r.kt)("p",null,"\u5bfc\u51fa Heap Snapshot\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"heap snapshot ","[filename]",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u7684 filename \u4e3a ",(0,r.kt)("inlineCode",{parentName:"li"},"core.heapsnapshot"),"\u3002")))),(0,r.kt)("p",null,"\u5982\u6307\u5b9a filename \u8bf7\u786e\u4fdd\u540e\u7f00\u4e3a heapsnapshot\uff0c\u5426\u5219\u65e0\u6cd5\u88ab DevTool \u8bc6\u522b\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"(gdb) heap snap\nSynchronize: (Strong roots)\nSynchronize: (Bootstrapper)\nSynchronize: (Relocatable)\nSynchronize: (Debugger)\nSynchronize: (Compilation cache)\nSynchronize: (Builtins)\nSynchronize: (Thread manager)\nOnStackTracedNodeSpace.Iterate NotImplemented.\nSynchronize: (Global handles)\nSynchronize: (Stack roots)\nSynchronize: (Handle scope)\nSynchronize: (Eternal handles)\nSynchronize: (Startup object cache)\nSynchronize: (Internalized strings)\nSynchronize: (External strings)\nIterated 1732 RO Heap Objects\nfailed RO Heap Object: 0\n(enum v8::internal::AllocationSpace) v8::internal::RO_SPACE\n(enum v8::internal::AllocationSpace) v8::internal::MAP_SPACE\n(enum v8::internal::AllocationSpace) v8::internal::CODE_SPACE\n(enum v8::internal::AllocationSpace) v8::internal::CODE_LO_SPACE\n(enum v8::internal::AllocationSpace) v8::internal::OLD_SPACE\n19.3%: 999.8/sec, Object(10000), Entry(34920), Edge(91684)\n(enum v8::internal::AllocationSpace) v8::internal::LO_SPACE\n(enum v8::internal::AllocationSpace) v8::internal::NEW_LO_SPACE\n(enum v8::internal::AllocationSpace) v8::internal::NEW_SPACE\nIterated 43904 Objects\nfailed HeapObject: 0\nheap snapshot written to 'core.heapsnapshot'\nGenerate() takes 14.629 second(s).\n")),(0,r.kt)("p",null,"\u5bf9\u8c61\u591a\u65f6\u9700\u8981\u66f4\u591a\u65f6\u95f4\uff0c\u89c6 node \u548c edges \u6570\u91cf\u53ef\u80fd\u957f\u8fbe\u6570\u5c0f\u65f6\u3002"))}u.isMDXComponent=!0}}]);